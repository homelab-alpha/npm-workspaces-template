---
name: ğŸ›¡ï¸ CodeQL Security Analysis

on:
  schedule:
    - cron: "0 3 * * 0"

  workflow_dispatch:

permissions:
  security-events: write
  packages: read
  actions: read
  contents: read

jobs:
  analyze:
    name: ğŸ” Analyze (${{ matrix.language }})
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    timeout-minutes: ${{ (matrix.language == 'swift' && 120) || 360 }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: actions
            build-mode: none
          - language: javascript-typescript
            build-mode: none

    steps:
      - name: ğŸ Notify start of analysis
        run: |
          echo "::notice title=CodeQL Started::Starting security scan for ${{ matrix.language }}"
          echo "::group::â„¹ï¸ Environment Details"
          echo "Language: ${{ matrix.language }}"
          echo "Build Mode: ${{ matrix.build-mode }}"
          echo "Runner: ${{ runner.os }}"
          echo "::endgroup::"

      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6.0.2

      - name: ğŸ—ï¸ Initialize CodeQL
        uses: github/codeql-action/init@v4.32.3
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}

      - name: ğŸ› ï¸ Execute manual build
        if: matrix.build-mode == 'manual'
        shell: bash
        run: |
          echo "::group::ğŸ”¨ Build Instructions"
          echo 'If you are using a "manual" build mode for one or more of the' \
            'languages you are analyzing, replace this with the commands to build' \
            'your code, for example:'
          echo '  make bootstrap'
          echo '  make release'
          echo "::endgroup::"
          echo "::error title=Build Required::Manual build mode detected but no build commands provided."
          exit 1

      - name: ğŸ§ª Perform CodeQL Analysis
        id: codeql_analysis
        uses: github/codeql-action/analyze@v4.32.3
        with:
          category: "/language:${{matrix.language}}"

      - name: ğŸ“Š Generate job summary
        if: always()
        run: |
          echo "::group::ğŸ“Š Writing Summary Report"

          ANALYSIS_RESULT="${{ steps.codeql_analysis.outcome == 'success' && 'âœ… Success' || 'âŒ Failed' }}"

          cat <<EOF >> "$GITHUB_STEP_SUMMARY"
          ## ğŸ›¡ï¸ CodeQL Analysis Summary

          Execution completed at: $(date -u)

          ### ğŸ“ˆ Scan Results

          | Component | Language | Result |
          | :--- | :--- | :--- |
          | ğŸ” Security Scan | ${{ matrix.language }} | $ANALYSIS_RESULT |
          | ğŸ—ï¸ Build Mode | ${{ matrix.build-mode }} | âœ… Configured |

          ### âš™ï¸ Runtime Configuration

          - **Runner OS:** ${{ runner.os }}
          - **Database Category:** /language:${{ matrix.language }}
          - **Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### ğŸ§© Notes

          - Results are uploaded to the **Security** tab under Code Scanning alerts.
          EOF

          echo "::endgroup::"
